@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/App_Theme/V1-SeatingArrangementStyle.css" rel="stylesheet" />
<script src="~/App_Scripts/jquery.validate.js"></script>

@{
    FrontEnd.Models.JAVADBEntities db = new FrontEnd.Models.JAVADBEntities();

    int eventID = Convert.ToInt32(Request["eventID"]);
    var evt = db.tblEvents.Where(e => e.EventID == eventID).SingleOrDefault();

    string sessionID = Request.Cookies["Session"]["SessionID"];

    int minTicketsAllowed = Convert.ToInt32(TempData["minTicketsAllowed"]);
    int maxTicketsAllowed = Convert.ToInt32(TempData["maxTicketsAllowed"]);
}


<script src="~/App_Scripts/jquery.countdown.js"></script>
<script src="~/App_Scripts/jquery.cookie.min.js"></script>
<script src="~/App_Scripts/bootstrap.min.js"></script>
<script src="~/App_Scripts/jquery.validate.js"></script>

<link href="~/App_Theme/bootstrap.css" rel="stylesheet" />

<script src="https://www.paypal.com/sdk/js?client-id=AW3y6TJ_eeCUe4f0X1BT33IR2EuHy2IzWuAsHFWtKcoZJd3OsVDZkV3qPvS6J2NUp5JjWSjBxcihAFuU">
</script>


<script type="text/javascript">
    //window.onbeforeunload = function () { location.reload(); };
    $(function () {
        $("#btnPlaceOrder").hide();
        $("#spnLoader").hide();

        $("#frmBooking").validate({
            rules: {
                txtFirstName: {
                    required: true
                },
                txtEmail: {
                    required: true,
                    email: true
                },
                txtNoOfTickets: {
                    required: true,
                    min: @minTicketsAllowed,
                    digits: true
                }
            },
            messages: {
                txtFirstName: {
                    required: "Please enter name"
                },
                txtEmail: {
                    required: "Please enter email id",
                    email: "Please check email id format"
                },
                txtNoOfTickets: {
                    required: "Please enter valid number of tickets",
                    digits: "Number of tickets should be numeric",
                    min: "Minimum tickets allowed."
                }
            },
            errorPlacement: function (error, element) {
                if (element.attr("name") == "txtFirstName")
                    error.appendTo($('#lblName'));

                if (element.attr("name") == "txtEmail")
                    error.appendTo($('#lblEmail'));

                if (element.attr("name") == "txtNoOfTickets") {
                    $("#lblTickets").html("");
                    error.appendTo($('#lblTickets'));
                }
            }
        });

        var date = new Date();
        var midnight = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 23, 59, 59);

        if ($.cookie('refresh-@eventID') == null) {
            $.cookie('refresh-@eventID', 'true', { expires: midnight });
        }

        $('#clock').countdown('@DateTime.Now.AddMinutes(25.25).ToString("yyyy/MM/dd HH:mm:ss")')
        //$('#clock').countdown('@DateTime.Now.AddMinutes(0.10).ToString("yyyy/MM/dd HH:mm:ss")')
           .on('update.countdown', function (event) {
               var format = '%H:%M:%S';
               $(this).html(event.strftime(format));
           })
           .on('finish.countdown', function (event) {
               //ClearSession(false);
               $("#modalAlert").modal('show');
               $("#clock").html("00:00:00");
           });

        $("#txtNoOfTickets").on("blur", function () {

            checkSeatsAvailability();
        });
    });

    function checkSeatsAvailability() {
        $("#spnLoader").show();
        $("#lblTickets").html("");
        if ($("#txtNoOfTickets").val() > @maxTicketsAllowed) {
            $("#lblTickets").html("Exceeds maximum tickets allowed, " + @maxTicketsAllowed);
            $("#spnLoader").hide();
            $("#btnPlaceOrder").hide();
            return false;
        }
        if ($("#txtNoOfTickets").val() >= 1) {
            $.ajax({
                url: "/BookTickets/CheckSeatsAvailability",
                data: { eventID: '@Request["eventID"]', no_of_tickets: $("#txtNoOfTickets").val() },
                success: function (response) {
                    if (response.status == "YES") {
                        $("#spnLoader").hide();
                        CalculatePricing();
                        $("#btnPlaceOrder").show();
                        $("#lblTickets").html("");
                    }
                    else {
                        $("#spnLoader").hide();
                        $("#btnPlaceOrder").hide();
                        $("#lblTickets").html("Sorry, there are only " + response.ticket_stock + " tickets left.");
                        //alert("Sorry, there are only " + response.ticket_stock + " tickets left.");
                    }
                }
            });
        } else {
            $("#btnPlaceOrder").hide();
            $("#spnLoader").hide();
        }
	}
    function CalculatePricing() {
        //Why price is fixed to 40 here
        var price = -1; //40
        var no_of_tickets = $("#txtNoOfTickets").val();

        if (no_of_tickets != "" && no_of_tickets != "0" && !isNaN(no_of_tickets)) {
            no_of_tickets = parseInt(no_of_tickets);

			/*
            if (no_of_tickets >= 10)
                price = 40;
			*/

            var amount = (no_of_tickets * price);
            var str = '';
            str += '<tr>';
            str += '<td>' + no_of_tickets + '</td>'
            str += '<td>' + amount + '</td>'
            str += '</tr>';

           ///////// $("#lblTickets").html("").hide();
            $("#tbody").html(str);

			$("#txtAmount").val(amount);
        }
        else {

            str += '<tr>';
            str += '<td  colspan="2" class="TierClass">No Bookings Yet</td>'
            str += '</tr>';

            $("#lblTickets").html("");
            $("#lblTickets").html("Please enter valid number of tickets").show();
            $("#tbody").html(str);
        }
    }
    function PlaceOrder() {
        $("#modalLoader").modal('show');
	    if ($("#frmBooking").valid()) {

	        $("#btnPlaceOrder").hide();
	        $("#loader").html("<b>Processing...</b>");

	        $.ajax({
	            url: "/BookTickets/BookTickets",
	            data: $("#frmBooking").serialize(),
	            type: "POST",
	            success: function (response) {
	                if (response.status == "OK") {
	                    location.href = "/OrderSummary";
	                }
					else if (response.status == "OUT_OF_STOCK") {
						alert("Sorry, Tickets are out of stock.");
	                    $("#loader").html("");
                        $("#btnPlaceOrder").show();
                        $("#modalLoader").modal('hide');
					}
	                else if (response.status == "INVALID DATA") {
	                    alert("Oops..Data you have entered is invalid.");
	                    $("#loader").html("");
                        $("#btnPlaceOrder").show();
                        $("#modalLoader").modal('hide');
	                }
	            }
	        });
	    }
	    else {
	       return false;
	    }
	}
    function GenerateOrder(){
		if ($("#frmBooking").valid()) {
			$.ajax({
				url: "/BookTickets/CheckTicketStock",
				data: { eventID: '@Request["eventID"]', no_of_tickets: $("#txtNoOfTickets").val() },
				success: function(response) {
					if(response.status == "YES") {
						PlaceOrder();
					}
					else {
                        alert("Sorry, there are only " + response.ticket_stock + " tickets left.");

					}
				}
			});
		}
		else {
	       return false;
	    }
	}
    setTimeout(function () {
        var el = document.getElementById('alwaysFetch');
        el.value = el.value ? location.reload() : true;
    }, 0);
</script>

<div>
    <input id="alwaysFetch" type="hidden" />
    <div class="EventSeatHead">
        @evt.EventName @evt.EventType | Show time: @evt.ShowTime
    </div>

    <div class="MainOuterSeatingWrap">
        <div class="ContentWrap">
            <div class="MainInnerLabel">Diclaimer: If the payments of the tickets are not processed within 15 minutes then the current order will be cancelled automatically</div>
            <div class="MainInnerLabel">We need some details to email you your tickets....</div>
            <form id="frmBooking">
                <input type="hidden" class="InnerTxtBox" id="eventID" name="eventID" value="@Request["eventID"]" />
                <div class="InnerFieldsBlock">
                    <div class="InnerLabel">Name</div>
                    <div class="InnerTxtWrap">
                        <input type="text" class="InnerTxtBox"
                               maxlength="30"
                               id="txtFirstName" name="txtFirstName" />
                    </div>
                    <div id="lblName"></div>
                    <div class="clr"></div>
                </div>

                <div class="InnerFieldsBlock">
                    <div class="InnerLabel">Email ID</div>
                    <div class="InnerTxtWrap">
                        <input type="text" class="InnerTxtBox"
                               maxlength="50"
                               id="txtEmail" name="txtEmail" />
                    </div>
                    <div id="lblEmail"></div>
                    <div class="clr"></div>
                </div>

                <div class="InnerFieldsBlock">
                    <div class="InnerLabel">No Of Tickets</div>
                    <div class="InnerTxtWrap">
                        @*<input type="text" class="InnerTxtBox" id="txtNoOfTickets" name="txtNoOfTickets" />*@
                        <input oninput="numberOnly(this.id);" type="text"
                               pattern="\d*" maxlength="3"
                               class="InnerTxtBox" id="txtNoOfTickets"
                               name="txtNoOfTickets" />
                        <img class="spn-loader" src="/App_Images/indicator-big.gif" id="spnLoader" />
                    </div>
                    <div id="lblTickets"></div>
                    <div class="clr"></div>
                </div>
            </form>
        </div>
    </div>

    <div class="RightOuterSeatingWrap">

        <div class="BookDetHead">Booking Details</div>

        <div class="SessionTimeWrap">
            <div class="SessionTime">Session will timeout in:</div>
            <div id="clock">NA</div>
        </div>

        <div class="TiersHead">Tier Availability</div>
        <table class="TierTbl" border="1">
            <tr>
                <th>Tickets</th>
                <th>Cost Per ticket</th>
            </tr>
            <tr>
                <td class="TierClass">General Admission</td>

                @if (evt.EventID != 3039)
                {
                    <td>$40</td>
                }
                else
                {
                    <td>$50</td>
                }
            </tr>

        </table>

        <div class="BookingHead">Your Bookings</div>
        <table class="TierTbl" border="1">
            <tr>
                <th>Tickets</th>
                <th>Total Cost</th>
            </tr>
            <tbody id="tbody">
                <tr>
                    <td colspan="2" class="TierClass">No Bookings Yet</td>
                </tr>
            </tbody>
        </table>


        <input type="hidden" value="0" id="txtAmount" name="txtAmount" />

        <br />
        @if (evt.EventID != 3039)
        {
            <button class="btnBookings" onclick="JavaScript: PlaceOrder();" id="btnPlaceOrder">Proceed with Bookings</button><span id="loader"></span>
        }
        else
        {
            <button class="btnBookings" onclick="JavaScript: GenerateOrder();" id="btnPlaceOrder">Proceed with Bookings</button>
            <span id="loader"></span>
        }
    </div>
    <div class="clr"></div>
    <div class="modal fade" id="modalAlert" role="dialog"
         data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog err-pop" style="">
            <div class="modal-content">
                <div class="modal-header">
                </div>
                <div class="modal-body" style="text-align:center;">
                    Your Session is expired...
                    <div class="modal-dialog">
                        @Html.ActionLink("Return Home", "Index", "Events", new
                            { eventID = 3041,}, null)
                    </div>
                </div>
                <input id="hdnEventId" type="hidden" value="-1" />
            </div>
        </div>
    </div>
</div>
<script src="~/App_Scripts/scrollbooster.min.js"></script>

<script>
    function numberOnly(id) {
        // Get element by id which passed as parameter within HTML element event
        var element = document.getElementById(id);
        // This removes any other character but numbers as entered by user
        element.value = element.value.replace(/[^0-9]/gi, "");
    }

    let viewport = document.querySelector('.MainOuterSeatingWrap')
    let content = viewport.querySelector('.app-inner')

    let scr = new ScrollBooster({
        viewport: viewport,
        content: content,
        // textSelection: true,
        emulateScroll: true,
        onClick: (data, event) => {
            //event.preventDefault()
        },
        shouldScroll: (data, event) => {
            if (event.target.tagName == 'BUTTON') {
                return false
            } else {
                return true
            }
        },
        onUpdate: (data) => {
            // viewport.scrollLeft = data.position.x
            // viewport.scrollTop = data.position.y
            content.style.transform = `translate(
            ${-data.position.x}px,
            ${-data.position.y}px
          )`
        }
    })
</script>
