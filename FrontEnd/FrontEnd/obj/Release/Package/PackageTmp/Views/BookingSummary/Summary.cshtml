
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@model List<FrontEnd.Controllers.SelectedSeatsV5>

@{
    var evt = (FrontEnd.Models.tblEvent)ViewData["Event"];
    decimal totalAmount = 0;
    var ticketType = TempData["TicketType"];
    TempData.Keep("TicketType");
}



<div class="ContentWrap">
    <div class="MainInnerLabel">Your Order Summary</div>
    <div class="message-box">
            <p>Your are entitiled for Early Bird discounts.</p>
    </div>
    <div class="OrderSumWrap">
        <table border="1" class="ordTbl">
            <tr>
                <th>Show Details</th>
                <th>Total Seats</th>
                <th>Particulars</th>
                <th>Amount</th>
            </tr>
            @foreach (var seat in Model)
            {
                totalAmount += seat.Price;
                <tr>
                    <td>
                        <div class="ShowName">@evt.EventName @evt.EventType</div>
                        <div class="Theatre">
                            Location : <span class="showtdhigh">@evt.tblVenue.VenueName</span> | Date :
                            <span class="showtdhigh">@Convert.ToDateTime(evt.EventDate).ToString("dd-MMMM-yyyy")</span>
                        </div>
                    </td>
                    <td><div class="ShowSeat">@Model[0].NoOfSeats</div></td>
                    <td>
                        <div>Actual Price</div>
                    </td>
                    <td>
                        <div class="ShowCost">$ @Model[0].ActualPrice</div>
                    </td>
                </tr>
            }
            <tr>
                <td>
                    <div>
                        Seats Selected :
                        <br>@ViewData["Seats"]
                    </div>
                </td>
                <td></td>
                <td><div>Discount on Early Bird Price</div></td>
                <td><div>$ - @Model[0].DiscountedAmount</div></td>
            </tr>
            <tr>
                <td></td>
                <td></td>
                <td><div>Price after discount</div></td>
                <td><div>$ @Model[0].Price</div></td>
            </tr>
        </table>
        @{
            var couponUsed = (FrontEnd.Models.tblOrderCoupon)ViewData["CouponUsed"];
            if (couponUsed != null)
            {
                if (couponUsed.tblCoupon.DiscountIn == "Percentage")
                {
                    <div class="OrdTot">
                        <div class="TotalOrdBlock">
                            <div class="TotOrdLeft">Discount: <b>(@couponUsed.tblCoupon.CouponCode - @couponUsed.tblCoupon.Discount%)</b></div>
                            <div class="TotOrdRight">$@Decimal.Round(Convert.ToDecimal(ViewData["DiscountAmount"]), 2)</div>
                            <div class="clr"></div>
                        </div>
                        <div class="clr"></div>
                    </div>
                }
                else if (couponUsed.tblCoupon.DiscountIn == "Value")
                {
                    <div class="OrdTot">
                        <div class="TotalOrdBlock">
                            <div class="TotOrdLeft">Discount: <b>(@couponUsed.tblCoupon.CouponCode)</b></div>
                            <div class="TotOrdRight">$@Decimal.Round(Convert.ToDecimal(ViewData["DiscountAmount"]), 2)</div>
                            <div class="clr"></div>
                        </div>
                        <div class="clr"></div>
                    </div>
                }
                else if (couponUsed.tblCoupon.DiscountIn == "Value")
                {
                    <div class="OrdTot">
                        <div class="TotalOrdBlock">
                            <div class="TotOrdLeft">Discount: <b>(@couponUsed.tblCoupon.CouponCode)</b></div>
                            <div class="TotOrdRight">$@Decimal.Round(Convert.ToDecimal(ViewData["DiscountAmount"]), 2)</div>
                            <div class="clr"></div>
                        </div>
                        <div class="clr"></div>
                    </div>
                }
                else if (ticketType.ToString() == "EARLYBIRD")
                {
                    <div class="OrdTot">
                        <div class="TotalOrdBlock">
                            <div class="TotOrdLeft">Discount: <b>(xxx)</b></div>
                            <div class="TotOrdRight">$32342</div>
                            <div class="clr"></div>
                        </div>
                        <div class="clr"></div>
                    </div>
                }

            }
        }

        @{
            if (ViewData["ProcessingPercentage"] != null)
            {

                <div class="OrdTot">
                    <div class="TotalOrdBlock">
                        <div class="TotOrdLeft">Service Fees </div>
                        <div class="TotOrdRight">$@Decimal.Round(Convert.ToDecimal(ViewData["ProcessingFee"]), 2)</div>
                        <div class="clr"></div>
                    </div>
                    <div class="clr"></div>
                </div>
            }
        }



        <div class="OrdTot">
            <div class="TotalOrdBlock">
                <div class="TotOrdLeft">Total Amount:</div>
                <div class="TotOrdRight">$@Decimal.Round(Convert.ToDecimal(ViewData["Amount"]), 2)</div>
                <div class="clr"></div>
            </div>
            <div class="clr"></div>
        </div>

        <div class="OrdBtn">
            <button class="OrdBtnMain" type="button" onclick="ShowDetailForm();">Continue</button><span id="loader"></span>
        </div>

    </div>

    <div class="MainOuterSeatingWrap">
        <div class="ContentWrap" id="details" style="display:none;">
            <div class="MainInnerLabel">We need some details to email you your tickets....</div>
            <form id="frmBooking">
                <input type="hidden" class="InnerTxtBox" id="eventID" name="eventID" value="@Request["eventID"]" />
                <div class="InnerFieldsBlock">
                    <div class="InnerLabel">Name</div>
                    <div class="InnerTxtWrap"><input type="text" class="InnerTxtBox" id="txtFirstName" name="txtFirstName" /></div>
                    <div id="lblName"></div>
                    <div class="clr"></div>
                </div>

                <div class="InnerFieldsBlock">
                    <div class="InnerLabel">Email ID</div>
                    <div class="InnerTxtWrap"><input type="text" class="InnerTxtBox" id="txtEmail" name="txtEmail" /></div>
                    <div id="lblEmail"></div>
                    <div class="clr"></div>
                </div>

                <div class="InnerFieldsBlock">
                    <div class="InnerLabel">Mobile</div>
                    <div class="InnerTxtWrap"><input type="text" class="InnerTxtBox" id="txtMobile" name="txtMobile" maxlength="10" /></div>
                    <div id="lblMobile"></div>
                    <div class="clr"></div>
                </div>
            </form>
            <div>
                <button type="button" onclick="JavaScript: OverridePP();"
                        class="button-62" id="but_upload">
                    Override PayPal Payment
                </button>
            </div>
            <div class="FinalOrdBtn">
                    <div id="pp"></div>
                </div>
        </div>
    </div>


</div>


<div id="divLoading" style="margin: 0px; padding: 0px; position: fixed; right: 0px; top: 0px; width: 100%; height: 100%; background-color: rgb(102, 102, 102); z-index: 30001; opacity: 0.8;display:none;">
    <p style="position: absolute; color: White; top: 50%; left: 45%;">
        Loading, please wait...
        <img src="../App_Images/indicator-big.gif">
    </p>
</div>

<script type="text/javascript">
    @*var a =  @ViewData["isEarlyBird"]
        alert(a);*@

    function OverridePP() {
        var isOrderPlaced = false;
        // Show a success message to your buyer
        var email = $("#txtEmail").val();
        var name = $("#txtFirstName").val();
        var mobile = $("#txtMobile").val();
        //var ticketType = ({ Convert.ToBoolean(TempData["isEarlyBirdApplicable"]);} == true) ? "EARLYBIRD" : "GENERAL";
        //var ticketType = (isTrue1) ? "EARLYBIRD" : "GENERAL";
        
        $.ajax({
			url: '/BookingSummary/PlaceOrder',
			type: "POST",
			data: {
                orderID: 'override-paypal-id',
				email: email,
				name: name,
				mobile: mobile,
                eventID: '@Request["eventID"]',
                ticketType: '@ViewData["isEarlyBird"]',
                actualPrice: @Model[0].ActualPrice,
                discountedAmount: '@ViewData["DiscountedAmount"]',
                priceAfterDiscount: @Model[0].Price,
                processingFee: @ViewData["ProcessingFee"],
                amount: '@ViewData["Amount"]',
                intent: 'CAPTURE',
                status: 'COMPLETED',
				sessionId: '@Common.GetSessionID()',
			},
			success: function (response) {
				if(response.status == "OK") {
					isOrderPlaced = true;
					//location.href = "/BookingSuccess?tID=" + response.orderID;
					$.ajax({
						url: "/BookingSummary/BookUnconfirmedSeats",
                        data: {
                            eventID: '@Request["eventID"]',
                            orderID: response.orderID
                        }
                        ,type: "GET",
						success: function(unconf_response) {
							if(unconf_response == "OK") {
								location.href = "/BookingSuccess?tID=" + response.orderID;
							}
						}
					});
				}
			}
        });
    }
</script>

<script type="text/javascript">
    $("#modalLoader").modal('show');
    $(document).ready(function () {
        $("#modalLoader").modal('hide');
    });

	//window.addEventListener('unload', deleteCartData, false);

	var isOrderPlaced = false;

    window.addEventListener('beforeunload', (event) => {
	    if(isOrderPlaced == false) {
	        event.returnValue = 'Are you sure you want to leave?';
	    }
	});

    function deleteCartData() {
        var data = new FormData();

        data.append('eventID', @evt.EventID);

        if ("sendBeacon" in navigator) {
            navigator.sendBeacon("/BookingSummary/DeleteCart", data);
        }
        else {
            var client = new XMLHttpRequest();
            client.open("POST", "/BookingSummary/DeleteCart", false);
            client.send(data);
        }
    }


    $(function () {
        $("#frmBooking").validate({
            rules: {
                txtFirstName: {
                    required: true
                },
                txtEmail: {
                    required: true,
                    email: true
                },
                txtMobile: {
                    required: true,
                    digits: true
                }
            },
            messages: {
                txtFirstName: {
                    required: "Please enter name"
                },
                txtEmail: {
                    required: "Please enter email id",
                    email: "Please check email id format"
                },
                txtMobile: {
                    required: "Please enter mobile number",
                    digits: "Mobile number should be in digits"
                }
            },
            errorPlacement: function (error, element) {
                if (element.attr("name") == "txtFirstName")
                    error.appendTo($('#lblName'));

                if (element.attr("name") == "txtEmail")
                    error.appendTo($('#lblEmail'));

                if (element.attr("name") == "txtMobile") {
                    $("#lblMobile").html("");
                    error.appendTo($('#lblMobile'));
                }
            }
        });
    });



    function PlaceOrder() {
        $(".OrdBtnMain").hide();
        $("#loader").html("<b>Please wait....</b>");

        $.ajax({
            url: '/BookingSummary/PlaceOrder',
            data: { eventID: '@Request["eventID"]' },
            type: "POST",
            success: function (response) {
                if (response == "OK") {
                    alert("Booking confirmed! Your tickets have been sent to your registered email id.");
                    location.href = "/Home";
                }
            }
        });
    }

    function ShowDetailForm() {

        $("#details").show();

		$('html, body').animate({
			scrollTop: $("#details").offset().top
		}, 2000);

    }

	//validate & use coupon
    function CheckCoupon() {

        if ($("#txtCouponCode").val() != "") {

            var code = $("#txtCouponCode").val();

            $("#btnCoupon").hide();
            $("#coupon_loader").html("Processing...");

            $.ajax({
                url: "/V5Venue/CheckCouponCode",
                data: { code: code, eventID: '@Request["eventID"]' },
                type: 'GET',
                success: OnCheckCouponSuccess
            });
        }
        else
            alert("Please enter valid coupon code.");
    }

    function OnCheckCouponSuccess(msg) {
        if (msg == "OK")
            location.reload();
        else {
            alert(msg);
            $("#coupon_loader").html("");
            $("#btnCoupon").show();

        }
    }
</script>
