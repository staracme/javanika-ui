
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/App_Theme/V1-SeatingArrangementStyle.css" rel="stylesheet" />


@{
    FrontEnd.Models.JAVADBEntities db = new FrontEnd.Models.JAVADBEntities();

    var block1 = db.tblBlocks.Where(b => b.BlockNumber == "V1L1B1").SingleOrDefault();
    var block2 = db.tblBlocks.Where(b => b.BlockNumber == "V1L1B2").SingleOrDefault();

    int eventID = Convert.ToInt32(Request["eventID"]);
    var evt = db.tblEvents.Where(e => e.EventID == eventID).SingleOrDefault();

    var tiers = (List<FrontEnd.Models.tblTier>)ViewData["Tiers"];
}


<script src="~/App_Scripts/jquery.countdown.js"></script>
<script src="~/App_Scripts/jquery.cookie.min.js"></script>
<script type="text/javascript">

    $(function () {

        var date = new Date();
        var midnight = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 23, 59, 59);

        if ($.cookie('refresh-@eventID') == null) {
            $.cookie('refresh-@eventID', 'true', { expires: midnight });
        }


        $(".chkSeats").click(function () {
            var seatID = $(this).val();

            if ($(this).is(":checked")) {
                SelectSeat(seatID);
            }
            else {
                RemoveSeat(seatID);
            }
        });

        $('#clock').countdown('@DateTime.Now.AddMinutes(12).ToString("yyyy/MM/dd HH:mm:ss")')
           .on('update.countdown', function (event) {
               var format = '%H:%M:%S';
               $(this).html(event.strftime(format));
           })
           .on('finish.countdown', function (event) {
               ClearSession(false);
               $("#clock").html("00:00:00");
           });
    });

    function SelectSeat(seatID) {
        $.ajax({
            url: "/V1Venue/SelectSeat",
            data: { seatID: seatID, eventID: '@Request["eventID"]' },
            type: "GET",
            success: function (response) {
                var data = JSON.parse(response);

                if (data.status == "OK") {

                    var booking_table = data.selected_seats;
                    var str = "";

                    if (booking_table.length > 0) {
                        $.each(booking_table, function (i, key) {
                            str += '<tr>';
                            str += '<td class="TierClass">' + key.TierName + '</td>';
                            str += '<td>' + key.NoOfSeats + '</td>'
                            str += '<td>$' + key.TotalCost + '</td>';
                            str += '</tr>';
                        });
                        $("#tbody").html(str);
                    }
                    else {
                        str += '<tr>';
                        str += '<td colspan="3" class="TierClass">No Bookings Yet</td>';
                        str += '</tr>';

                        $("#tbody").html(str);
                    }
                }
                else {
                    console.log("Booked");
                }
            }
        });
    }

    function RemoveSeat(seatID) {
        $.ajax({
            url: "/V1Venue/RemoveSeat",
            data: { seatID: seatID, eventID: '@Request["eventID"]' },
            type: "GET",
            success: function (response) {
                var data = JSON.parse(response);

                if (data.status == "OK") {
                    var booking_table = data.selected_seats;
                    var str = "";

                    if (booking_table.length > 0) {
                        $.each(booking_table, function (i, key) {
                            str += '<tr>';
                            str += '<td class="TierClass">' + key.TierName + '</td>';
                            str += '<td>' + key.NoOfSeats + '</td>'
                            str += '<td>$' + key.TotalCost + '</td>';
                            str += '</tr>';
                        });
                        $("#tbody").html(str);
                    }
                    else {
                        str += '<tr>';
                        str += '<td colspan="3" class="TierClass">No Bookings Yet</td>';
                        str += '</tr>';
                        $("#tbody").html(str);
                    }
                }
                else {
                    console.log("Booked");
                }
            }
        });
    }

    function ClearSession(isRefresh) {
        if (!isRefresh) {
            alert("Your session has been timed out.");
          //  location.href = "/V1Venue/DeleteSession?eventID=@eventID&isRefresh=" + isRefresh;
        }
    }

    function ProceedBooking() {
        $("#frmBooking").submit();
    }
</script>

<div>
    <div class="EventSeatHead">
        @evt.EventName @evt.EventType | Show time: @evt.ShowTime | Venue: @evt.tblVenue.VenueName
    </div>

    <div class="MainOuterSeatingWrap">
        <div class="app-inner">
            <div class="StageWrap">Stage / Screen this side</div>
            <div>
                <div class="DragContent">Drag towards Right to view seats</div><div class="DragImg"><img src="~/App_Images/DragArrow.png" width="50px" /></div>
                <div class="clr"></div>
            </div>
            <br />
            @if (block1 != null)
            {
                var seat_rows = db.tblSeatRows.Where(b => b.BlockID == block1.BlockID).OrderBy(s => s.SeatRowID).ToList();

                var block_pricing = db.tblEventLayoutBlocks.Where(t => t.BlockID == block1.BlockID && t.EventID == eventID).SingleOrDefault();


                <ol id="@block1.BlockNumber" class="cabin fuselage">
                    @foreach (var row in seat_rows)
                    {
                        var seats = db.tblSeats.Where(s => s.SeatRowID == row.SeatRowID).ToList();
                        <li class="row">
                            <ol class="seats" type="@row.RowNumber">
                                @foreach (var seat in seats)
                                {
                                    if (seat.Status == "PRESENT")
                                    {
                                        var isBooked = db.tblSeatSelections.SqlQuery("SELECT * FROM TBLSEATSELECTIONS WHERE SEATID = " + seat.SeatID + " AND EVENTID =" + eventID + " AND ORDERID IS NOT NULL AND TICKETID IN (SELECT TICKETID FROM TBLTICKETS WHERE STATUS = 'CONFIRMED')").Any();

                                        <li class="seat">
                                            <input type="checkbox" id="@seat.SeatNumber" class="chkSeats" value="@seat.SeatID" @(isBooked ? "disabled" : "") />
                                            <label for="@seat.SeatNumber">@seat.SeatNumber</label>
                                            <div class="tooltip">@(block_pricing.tblTier.TierName) - $@(block_pricing != null ? Decimal.Round(Convert.ToDecimal(block_pricing.Price)) : 0)</div>
                                        </li>
                                    }
                                    else if (seat.Status == "BLANK")
                                    {
                                        <li class="seat">

                                        </li>
                                    }
                                }
                            </ol>
                        </li>
                    }
                </ol>
            }

            @if (block2 != null)
            {
                var seat_rows = db.tblSeatRows.Where(b => b.BlockID == block2.BlockID).OrderBy(s => s.SeatRowID).ToList();

                var block_pricing = db.tblEventLayoutBlocks.Where(t => t.BlockID == block2.BlockID && t.EventID == eventID).SingleOrDefault();

                <ol id="@block2.BlockNumber" class="cabin fuselage">
                    @foreach (var row in seat_rows)
                    {
                        var seats = db.tblSeats.Where(s => s.SeatRowID == row.SeatRowID).ToList();

                        <li class="row">
                            <ol class="seats" type="@row.RowNumber">
                                @foreach (var seat in seats)
                                {
                                    if (seat.Status == "PRESENT")
                                    {
                                        var isBooked = db.tblSeatSelections.SqlQuery("SELECT * FROM TBLSEATSELECTIONS WHERE SEATID = " + seat.SeatID + " AND EVENTID =" + eventID + " AND TICKETID IS NOT NULL AND TICKETID IN (SELECT TICKETID FROM TBLTICKETS WHERE STATUS = 'CONFIRMED')").Any();

                                        <li class="seat">
                                            <input type="checkbox" id="@seat.SeatNumber" class="chkSeats" value="@seat.SeatID" @(isBooked ? "disabled" : "") />
                                            <label for="@seat.SeatNumber">@seat.SeatNumber</label>
                                            <div class="tooltip">@(block_pricing.tblTier.TierName) - $@(block_pricing != null ? Decimal.Round(Convert.ToDecimal(block_pricing.Price)) : 0)</div>
                                        </li>
                                    }
                                    else if (seat.Status == "BLANK")
                                    {
                                        <li class="seat">

                                        </li>
                                    }
                                }
                            </ol>
                        </li>
                    }
                </ol>
            }
        </div>
    </div>

    <div class="RightOuterSeatingWrap">

        <div class="BookDetHead">Booking Details</div>

        <div class="SessionTimeWrap">
            <div class="SessionTime">Session will timeout in:</div>
            <div id="clock">15.00</div>
        </div>

        <div class="TiersHead">Tier Availability</div>
        <table class="TierTbl" border="1">
            <tr>
                <th>Tier</th>
                <th>Available Seats</th>
                <th>Cost</th>
            </tr>
            @foreach (var tier in tiers)
            {
                var seats = db.tblSeats.SqlQuery("SELECT * FROM TBLSEAT WHERE SEATROWID IN (SELECT SEATROWID FROM TBLSEATROWS WHERE BLOCKID IN (SELECT BLOCKID FROM tblEventLayoutBlocks WHERE EVENTID = " + eventID + " AND TIERID = " + tier.TierID + ")) AND STATUS = 'PRESENT'").Count();
                var get_price = db.tblEventLayoutBlocks.Where(e => e.TierID == tier.TierID && e.EventID == eventID).SingleOrDefault();
                <tr>
                    <td class="TierClass">@tier.TierName</td>
                    <td>@seats</td>
                    <td>$@(get_price != null ? Decimal.Round(Convert.ToDecimal(get_price.Price)) : 0)</td>
                </tr>
            }
        </table>

        <div class="BookingHead">Your Bookings</div>
        <table class="TierTbl" border="1">
            <tr>
                <th>Tier</th>
                <th>Seats</th>
                <th>Total Cost</th>
            </tr>
            <tbody id="tbody">
                <tr>
                    <td colspan="3" class="TierClass">No Bookings Yet</td>

                </tr>
            </tbody>


        </table>

        <form id="frmBooking" method="post" action="/BookingSummary">
            <input type="hidden" id="eventID" name="eventID" value="@Request["eventID"]" />
        </form>

        @if (Common.IsLoggedIn())
        {
            <button class="btnBookings" onclick="JavaScript: ProceedBooking();">Proceed with Bookings</button>
        }
        else
        {
            <button class="btnBookings" onclick="JavaScript:OpenPopup('venue_page');">Proceed with Bookings</button>
        }
    </div>



    <div class="clr"></div>
</div>
<script src="~/App_Scripts/scrollbooster.min.js"></script>

<script>
    let viewport = document.querySelector('.MainOuterSeatingWrap')
    let content = viewport.querySelector('.app-inner')

    let scr = new ScrollBooster({
        viewport: viewport,
        content: content,
        // textSelection: true,
        emulateScroll: true,
        onClick: (data, event) => {
            //event.preventDefault()
        },
        shouldScroll: (data, event) => {
            if (event.target.tagName == 'BUTTON') {
                return false
            } else {
                return true
            }
        },
        onUpdate: (data) => {
            // viewport.scrollLeft = data.position.x
            // viewport.scrollTop = data.position.y
            content.style.transform = `translate(
            ${-data.position.x}px,
            ${-data.position.y}px
          )`
        }
    })
</script>
